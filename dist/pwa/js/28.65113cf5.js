(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[28],{2648:function(t,e,o){"use strict";o.r(e);var s=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("q-page",{attrs:{padding:""}},[o("q-header",{staticClass:"bg-darkl1",attrs:{elevated:""}},[o("q-toolbar",[o("q-btn",{attrs:{flat:"",rounded:"",dense:"",icon:"keyboard_backspace",color:"white"},on:{click:function(e){return t.$router.push("/almacen/contador")}}}),t._v("\n            Inventario "+t._s(this.$route.params.id)+"\n        ")],1),o("q-separator"),o("q-toolbar",[o("q-linear-progress",{attrs:{rounded:"",dark:"",size:"15px",value:t.progress.value,color:"primary"}},[o("div",{staticClass:"absolute-center flex flex-center"},[o("q-badge",{attrs:{color:"none","text-color":"white",label:t.progress.label}})],1)])],1)],1),t.index?[o("q-card",{staticClass:"bg-darkl1 text-grey-5 exo"},[o("q-card-section",[o("q-table",{attrs:{dark:"",flat:"","card-class":"bg-none",data:t.tableProducts.rows,columns:t.tableProducts.columns,"visible-columns":t.visibleCols},scopedSlots:t._u([{key:"body",fn:function(e){return[o("q-tr",{attrs:{props:e}},[o("q-td",{key:"id",attrs:{props:e}},[t._v(t._s(e.row.id))]),o("q-td",{key:"code",attrs:{props:e}},[t._v("\n                                "+t._s(e.row.code)),o("br"),o("span",{staticClass:"text--2 text-grey-6"},[t._v(t._s(e.row.description))])]),o("q-td",{key:"locations",attrs:{props:e}},[t._v(t._s(e.row._locations))]),o("q-td",{key:"sai",attrs:{props:e}},[t._v(t._s(e.row.sai))]),o("q-td",{key:"counter",attrs:{props:e}},[t._v(t._s(e.row.counter))]),o("q-td",{key:"sat",attrs:{props:e}},[t._v(t._s(e.row.sat))]),o("q-td",{key:"ufs",attrs:{props:e}},[t._v(t._s(e.row.ufs))]),o("q-td",{key:"presition",attrs:{props:e}},[t._v(t._s(e.row.presition))]),o("q-td",{key:"countby",attrs:{props:e}},[t._v(t._s(e.row.by))]),o("q-td",{key:"state",attrs:{props:e}},[1==e.row.state?[o("q-icon",{attrs:{name:"done",color:"green-13",size:"sm"}})]:t._e(),2==e.row.state?[o("q-spinner-dots",{attrs:{color:"amber-13",size:"sm"}}),o("br"),t.countingrespo?o("span",{staticClass:"text-amber-12 text--2"},[t._v("("+t._s(t.countingrespo.me.nick)+")")]):t._e()]:t._e(),3==e.row.state?[o("q-btn",{attrs:{size:"sm",flat:"",rounded:"",color:"amber-13",icon:"fas fa-pencil-alt"},on:{click:function(o){return t.counter(e)}}})]:t._e()],2)],1)]}}],null,!1,3599053510)})],1)],1),o("q-dialog",{attrs:{position:"bottom",persistent:""},model:{value:t.wndCounter.state,callback:function(e){t.$set(t.wndCounter,"state",e)},expression:"wndCounter.state"}},[null!=t.wndCounter.idxrow?o("q-card",{staticClass:"bg-darkl0 text-grey-5 exo"},[o("q-card-section",[t._v("\n                    "+t._s(t.tableProducts.rows[t.wndCounter.idxrow].code)),o("br"),o("span",{staticClass:"text--2"},[t._v(t._s(t.tableProducts.rows[t.wndCounter.idxrow].description))])]),o("q-separator"),o("q-card-section",{staticClass:"q-gutter-md"},[t._l(t.tableProducts.rows[t.wndCounter.idxrow].locations,(function(e,s){return o("q-input",{key:s,attrs:{dark:"",color:"green-13",autofocus:0==s,min:"0",type:"number"},scopedSlots:t._u([{key:"prepend",fn:function(){return[o("span",{staticClass:"text--2"},[t._v(t._s(e.path)+" :")])]},proxy:!0}],null,!0),model:{value:t.wndCounter.counters[s],callback:function(e){t.$set(t.wndCounter.counters,s,e)},expression:"wndCounter.counters[idx]"}})})),t.tableProducts.rows[t.wndCounter.idxrow].locations.length>1?o("div",[t._v("Total: "+t._s(t.counterToSave))]):t._e()],2),o("q-card-actions",{attrs:{align:"around"}},[o("q-btn",{attrs:{label:"Cancelar",flat:"",rounded:"",color:"light-blue-13","no-caps":""},on:{click:t.counterCancel}}),t.wndCounter.counters.length?[o("q-btn",{attrs:{flat:"","no-caps":"",rounded:"",color:"green-13",label:"Guardar",disable:t.wndCounter.saving,loading:t.wndCounter.saving},on:{click:t.save}})]:t._e()],2)],1):t._e()],1),this.index?[2==this.index.inventory.status.id&&t.imCreator&&1==t.progress.value?o("q-page-sticky",{attrs:{position:"bottom-right",offset:[10,10]}},[o("q-btn",{staticClass:"bg-darkl1 text-green-13",attrs:{rounded:"",icon:"done",label:"Terminar","no-caps":""},on:{click:t.terminate}})],1):t._e(),3==this.index.inventory.status.id?o("q-page-sticky",{attrs:{position:"bottom-right",offset:[10,10]}},[o("q-btn",{staticClass:"bg-darkl1 text-green-13",attrs:{rounded:"",icon:"fas fa-file-download",label:"Reporte","no-caps":"",loading:t.bpdf.state},on:{click:t.buildPDF}})],1):t._e()]:t._e()]:t._e()],2)},n=[],i=(o("e01a"),o("13d5"),o("e6cf"),o("ddb0"),o("8e27")),r=o.n(i),a=o("e0df"),l=o("007d"),d=o("8baf"),c=(o("0da4"),{data(){return{index:null,tableProducts:{rows:[],columns:[{name:"id",align:"left",label:"ID",field:t=>t.id,sortable:!0},{name:"code",align:"left",label:"Codigo",field:t=>t.code,sortable:!0},{name:"locations",align:"center",label:"Ubicaciones",field:t=>t._locations,sortable:!0},{name:"sai",align:"center",label:"SAI",field:t=>t.state,sortable:!0},{name:"counter",align:"center",label:"Conteo",field:t=>t.counter,sortable:!0},{name:"sat",align:"center",label:"SAT",field:t=>t.state,sortable:!0},{name:"ufs",align:"center",label:"F/S",field:t=>t.ufs,sortable:!0},{name:"presition",align:"center",label:"Presicion",field:t=>t.presition,sortable:!0},{name:"countby",align:"center",label:"Conto",field:t=>t.by,sortable:!0},{name:"state",align:"center",label:"Estatus",field:t=>t.state,sortable:!0}]},socket:null,imCreator:!1,wndCounter:{state:!1,idxrow:null,counters:[],saving:!1,stateIfCancel:null},sktcounter:null,countingrespo:null,joined:!1,bpdf:{state:!1}}},async beforeMount(){this.$store.commit("Layout/hideToolbarModule"),this.$q.loading.show({message:"Validando...",spinner:l["a"],spinnerColor:"green-13"}),this.index=await a["a"].find(this.$route.params.id),console.log(this.index.inventory.products),this.index.success?this.stay()?(this.index.inventory.products.forEach((t=>{console.log(t);let e=this.rowCalcs(t);console.log(e),t.state=t.ordered.details.settings?1:3,t._locations=t.locations.map((t=>t.path)).join(", "),t.sai=t.ordered.stocks,t.counter=t.ordered.stocks_acc,t.sat=t.ordered.stocks_end,t.ufs=e.ufs,t.presition=e.presition,this.tableProducts.rows.unshift(JSON.parse(JSON.stringify(t)))})),this.sktcounter=await r()(`${this.$vsocket}/counters`),this.sktcounter.emit("joinat",{room:this.socketroom,user:this.profile}),this.sktcounter.on("joined",(t=>{this.sktjoined(t)})),this.sktcounter.on("counting",(t=>{this.sktcounting(t)})),this.sktcounter.on("cancelcounting",(t=>{this.sktcancelcounting(t)})),this.sktcounter.on("countingconfirmed",(t=>{this.sktcountingconfirmed(t)}))):this.notifyExclution():this.notify404(),this.$q.loading.hide()},beforeDestroy(){this.$store.commit("Layout/showToolbarModule")},methods:{sktcountingconfirmed(t){console.log("%cSe ha confirmado un conteo!!!","font-size:2em;color:gold"),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.tableProducts.rows[e].state=1,this.tableProducts.rows[e].counter=t.settings.stock},sktjoined(t){t.me.id!=this.profile.me.id&&this.$q.notify({color:"dark",message:`${t.me.nick} se ha unido al conteo`,position:"bottom-left",textColor:"green-13",timeout:1200,avatar:"https://cdn.quasar.dev/img/boy-avatar.png"})},sktcounting(t){console.log("Contando elemento..."),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.countingrespo=t.by,this.tableProducts.rows[e].state=2},sktcancelcounting(t){console.log("Cancelando elemento de forma remota"),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.tableProducts.rows[e].state=3,this.countingrespo=null},terminate(t,e){this.$q.loading.show({message:"Finalizando Inventario, espera..."});let o={_inventory:this.index.inventory.id,_status:3};a["a"].nextStep(o).then((t=>{let e=t.data;console.log(JSON.stringify(e.order.products)),this.index.inventory.products=e.order.products,this.index.inventory.status=e.order.status,this.index.inventory.log=e.order.log,this.$q.loading.hide(),this.$q.notify({icon:"done",color:"positive",message:"Inventario finalizado!!"})})).catch((t=>{console.log(t)}))},save(){this.wndCounter.saving=!0,this.tableProducts.rows[this.wndCounter.idxrow].counter=this.counterToSave,this.tableProducts.rows[this.wndCounter.idxrow].ordered.stocks_acc=this.counterToSave,this.tableProducts.rows[this.wndCounter.idxrow].state=1;let t=this.tableProducts.rows[this.wndCounter.idxrow],e={_product:t.id,_inventory:this.index.inventory.id,stock:this.counterToSave,settings:{locs:t.locations,values:this.wndCounter.counters,modified:!0}};a["a"].rowCount(e).then((o=>{o.data;let s=this.rowCalcs(t);this.tableProducts.rows[this.wndCounter.idxrow].presition=s.presition,this.tableProducts.rows[this.wndCounter.idxrow].ufs=s.ufs,this.tableProducts.rows[this.wndCounter.idxrow].state=1,this.$q.notify({color:"positive",icon:"done",position:"center",timeout:1e3,message:"Guardado!"}),console.log("%cConfirmando conteo...!!!","font-size:2em;color:gold"),this.sktcounter.emit("countingconfirmed",{room:this.socketroom,product:t,by:this.profile,settings:e}),this.counterReset(),this.wndCounter.state=!1})).catch((t=>{console.log(t)}))},rowCalcs(t){console.log(t);let e={ufs:null,presition:null,by:null},o=t.ordered.stocks_acc,s=t.ordered.stocks;return null!=o&&(e.ufs=o-s,e.by=t.ordered.details.editor,s>o?(console.log("El sai es mayor a lo contado"),e.presition=(o/s*100).toFixed(0)):o>s?(console.log("El sai es menor a lo contado"),e.presition=(s/o*100).toFixed(0)):s==o?(console.log("El sai es igual a lo contado"),e.presition=100,e.ufs=0):console.log("Algo salio remal")),e},counterCancel(){console.log("Se ha Cancelado el Contador"),this.tableProducts.rows[this.wndCounter.idxrow].state=this.wndCounter.stateIfCancel,this.sktcounter.emit("cancelcounting",{room:this.socketroom,by:this.profile,product:this.tableProducts.rows[this.wndCounter.idxrow]}),this.counterReset(),this.wndCounter.state=!1},counter(t){console.log(t);let e=t.key,o=this.tableProducts.rows.findIndex((t=>t.id==e));this.wndCounter.stateIfCancel=this.tableProducts.rows[o].state,this.tableProducts.rows[o].state=2,this.wndCounter.idxrow=o,this.wndCounter.state=!0;let s=this.tableProducts.rows[o];this.sktcounter.emit("counting",{room:this.socketroom,product:s,by:this.profile})},counterReset(){this.wndCounter.idxrow=null,this.wndCounter.counters=[],this.wndCounter.saving=!1,this.countingrespo=null},stay(){if(this.index.inventory.created_by.id==this.profile.me.id||1==this.profile.me._rol)return this.imCreator=!0,!0;{let t=this.index.inventory.responsables.findIndex((t=>t.id==this.profile.me.id));return t>=0}},notifyExclution(){this.$q.notify({message:"Raios!!, No eres miembro de este conteo!!",icon:"fas fa-sad-cry",timeout:1e3,color:"negative",position:"top"}),this.$router.push("/almacen/contador")},notify404(){this.$q.notify({message:`Raios!!, el folio ${this.$route.params.id} no existe!!`,icon:"fas fa-sad-cry",timeout:1e3,color:"negative",position:"top"}),this.$router.push("/almacen/contador")},buildPDF(){this.bpdf.state=!0,this.$q.loading.show({message:"Generando Reporte..."}),console.log(this.index);let t=this.log.filter((t=>1==t.id))[0],e=this.log.filter((t=>3==t.id))[0],o=this.$moment(t.created_at),s=this.$moment(e.created_at),n=s.diff(o,"m"),i=1,r=`21-${this.index.inventory.id}`,a=`${r}.pdf`,l=o.format("MM/DD/YYYY h:mm a"),c=s.format("MM/DD/YYYY h:mm a"),u=this.index.inventory.type,h=`${this.index.inventory.created_by.names} ${this.index.inventory.created_by.surname_pat} [${this.index.inventory.created_by.nick}]`,p=this.index.inventory.responsables;const g=new d["jsPDF"]({unit:"pt",format:"letter"});g.addFont("pdf/ParadroidMono-Light.ttf","Paradroid","normal"),g.setFont("Paradroid");let m={w:g.internal.pageSize.getWidth(),h:g.internal.pageSize.getHeight()},b=m.w-50,f=m.h-80,w=[...this.tableProducts.rows].map((t=>{let e=parseInt(t.ordered.stocks),o=parseInt(t.ordered.stocks_acc),s=()=>e>o?"-"+(e-o):e<o?"+"+(o-e):e==o?0:void 0,n=()=>e>o?(o/e*100).toFixed(0):o>e?(e/o*100).toFixed(0):e==o?100:void 0,i=()=>{let e=t.description.length>=35?t.description.substring(0,35)+"...":t.description;return e.toUpperCase()};return[t.code,i(),e,o,s(),"","",n()]}));var x=[{name:"code",prompt:"Articulo",width:70},{name:"descript",prompt:"Descripcion",width:185},{name:"initstock",prompt:"SAI",width:40},{name:"counter",prompt:"UC",width:40},{name:"fs",prompt:"F/S",width:40},{name:"endstock",prompt:"SAT",width:40},{name:"locations",prompt:"Ubicaciones",width:100},{name:"presition",prompt:"Pres.",width:40}];let C=t=>{g.setFontSize(7),g.text(`${i}`,b/2+10,f+50,{align:"center",baseline:"middle"}),g.text(`Inventario ${r}, ${this.workin.workpoint.name}`,575,f+50,{align:"right",baseline:"middle"})},k=(t,e)=>{g.setFillColor("#000000"),g.line(t,e,575,e,"F"),e+=20;let o=1;g.setFontSize(11);for(const s of x)g.setTextColor("#2d3436"),g.text(`${s.prompt}`,t,e),o++,o>1&&(t+=s.width);t=25,e+=13,g.setFillColor("#000000"),g.line(t,e,575,e,"F")};g.addImage("pdf/rsi.png","PNG",355,5,250,60),g.addImage("pdf/logo_org.png","PNG",35,22,170,50),g.setFontSize(12),g.setTextColor("#ffffff"),g.text(`Inventario ${r}`,570,29,{align:"right",baseline:"middle"}),g.setFontSize(10),g.text(`${this.workin.workpoint.name}`,570,45,{align:"right",baseline:"middle"}),g.setTextColor("#000000");let y=25,v=112;g.text("Duracion: ",y,v),g.text("Inicio: ",y,v+=13),g.text("Termino: ",y,v+=13),g.text("Tipo: ",y,v+=13),y=80,v=112,g.text(`${n} minutos`,y,v),g.text(`${l}`,y,v+=13),g.text(`${c}`,y,v+=13),g.text(`${u.name}`,y,v+=13),y=290,v=112,g.text("Administrador: ",y,v),g.text("Responsables: ",y,v+=13),g.text("Productos: ",y,v+=13),y=380,v=112,g.text(`${h}`,y,v),g.text(`${p.length}`,y,v+=13),g.text(`${this.index.inventory.products.length}`,y,v+=13),k(25,170),C(1),g.setFontSize(8),y=25,v=205;let _=0;for(const d of w){_%2==0?g.setFillColor("#ffffff"):g.setFillColor("#ced6e0"),g.rect(y,v,550,20,"F");for(let t=0;t<d.length;t++)g.text(`${d[t]}`,y,v+7,{baseline:"hanging"}),y+=x[t].width;v>f?(v=70,g.addPage(),i++,k(25,30),C(1,1),g.setFontSize(8),i++):v+=20,_++,y=25}g.setFontSize(12),v+=40,y=25,v+=10,g.setFontSize(10);for(const d of p)g.text(`${d.names} ${d.surname_pat}`,25,v+=30,{baseline:"hanging"});g.save(a),this.$q.loading.hide(),this.bpdf.state=!1}},computed:{workin(){return this.$store.getters["Account/workin"]},profile(){return this.$store.getters["Account/profile"]},rowsDone(){return this.tableProducts.rows.filter((t=>null!=t.counter))},progress(){let t=0,e=this.tableProducts.rows.length,o=this.rowsDone.length,s=this.index?parseFloat((100*o/e).toFixed(2)):0,n=`${o} de ${e} : ${s}%`;return t=parseFloat(s/100).toFixed(2),{label:n,value:parseFloat(t)}},counterToSave(){return null!=this.wndCounter.idxrow?this.wndCounter.counters.reduce(((t,e)=>t+parseInt(e)),0):null},ismobile(){return this.$q.platform.is.mobile},socketroom(){return`COUNTER${this.$route.params.id}`},log(){return this.index?this.index.inventory.log:[]},visibleCols(){return this.index&&3!=this.index.inventory.status.id?["code","locations","counter","state"]:["code","locations","sai","counter","sat","ufs","presition","countby","state"]}}}),u=c,h=o("2877"),p=o("9989"),g=o("e359"),m=o("65c6"),b=o("9c40"),f=o("eb85"),w=o("6b1d"),x=o("58a81"),C=o("f09f"),k=o("a370"),y=o("eaac"),v=o("bd08"),_=o("db86"),$=o("0016"),q=o("8380"),P=o("24e8"),S=o("27f9"),F=o("4b7e"),I=o("de5e"),T=o("eebe"),z=o.n(T),Q=Object(h["a"])(u,s,n,!1,null,null,null);e["default"]=Q.exports;z()(Q,"components",{QPage:p["a"],QHeader:g["a"],QToolbar:m["a"],QBtn:b["a"],QSeparator:f["a"],QLinearProgress:w["a"],QBadge:x["a"],QCard:C["a"],QCardSection:k["a"],QTable:y["a"],QTr:v["a"],QTd:_["a"],QIcon:$["a"],QSpinnerDots:q["a"],QDialog:P["a"],QInput:S["a"],QCardActions:F["a"],QPageSticky:I["a"]})}}]);