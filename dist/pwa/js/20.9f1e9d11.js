(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[20],{1:function(t,e){},2648:function(t,e,o){"use strict";o.r(e);var n=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("q-page",{attrs:{padding:""}},[o("q-header",{staticClass:"bg-darkl1",attrs:{elevated:""}},[o("q-toolbar",[o("q-btn",{attrs:{flat:"",rounded:"",dense:"",icon:"keyboard_backspace",color:"white"},on:{click:function(e){return t.$router.push("/almacen/contador")}}}),t._v("\n            Inventario "+t._s(this.$route.params.id)+"\n        ")],1),o("q-separator"),o("q-toolbar",[o("q-linear-progress",{attrs:{rounded:"",dark:"",size:"15px",value:t.progress.value,color:"primary"}},[o("div",{staticClass:"absolute-center flex flex-center"},[o("q-badge",{attrs:{color:"none","text-color":"white",label:t.progress.label}})],1)])],1)],1),t.index?[o("q-card",{staticClass:"bg-darkl1 text-grey-5 exo"},[o("q-card-section",[o("q-table",{attrs:{dark:"",flat:"","card-class":"bg-none",data:t.tableProducts.rows,columns:t.tableProducts.columns,"visible-columns":t.tableProducts.visibleCols},scopedSlots:t._u([{key:"body",fn:function(e){return[o("q-tr",{attrs:{props:e}},[o("q-td",{key:"id",attrs:{props:e}},[t._v(t._s(e.row.id))]),o("q-td",{key:"code",attrs:{props:e}},[t._v("\n                                "+t._s(e.row.code)+"\n                                "),o("br"),o("span",{staticClass:"text--2 text-grey-6"},[t._v(t._s(e.row.description))])]),o("q-td",{key:"description",attrs:{props:e}},[t._v(t._s(e.row.description))]),o("q-td",{key:"locations",attrs:{props:e}},[t._v(t._s(e.row._locations))]),o("q-td",{key:"counter",attrs:{props:e}},[t._v(t._s(e.row.counter))]),o("q-td",{key:"state",attrs:{props:e}},[1==e.row.state?[o("q-icon",{attrs:{name:"done",color:"green-13",size:"sm"}})]:t._e(),2==e.row.state?[o("q-spinner-dots",{attrs:{color:"amber-13",size:"sm"}}),o("br"),t.countingrespo?o("span",{staticClass:"text-amber-12 text--2"},[t._v("("+t._s(t.countingrespo.me.nick)+")")]):t._e()]:t._e(),3==e.row.state?[o("q-btn",{attrs:{size:"sm",flat:"",rounded:"",color:"amber-13",icon:"fas fa-pencil-alt"},on:{click:function(o){return t.counter(e)}}})]:t._e()],2)],1)]}}],null,!1,1977989852)})],1)],1),o("q-dialog",{attrs:{position:"bottom",persistent:""},model:{value:t.wndCounter.state,callback:function(e){t.$set(t.wndCounter,"state",e)},expression:"wndCounter.state"}},[null!=t.wndCounter.idxrow?o("q-card",{staticClass:"bg-darkl0 text-grey-5 exo"},[o("q-card-section",[t._v("\n                    "+t._s(t.tableProducts.rows[t.wndCounter.idxrow].code)),o("br"),o("span",{staticClass:"text--2"},[t._v(t._s(t.tableProducts.rows[t.wndCounter.idxrow].description))])]),o("q-separator"),o("q-card-section",{staticClass:"q-gutter-md"},[t._l(t.tableProducts.rows[t.wndCounter.idxrow].locations,(function(e,n){return o("q-input",{key:n,attrs:{dark:"",color:"green-13",autofocus:0==n,min:"0",type:"number"},scopedSlots:t._u([{key:"prepend",fn:function(){return[o("span",{staticClass:"text--2"},[t._v(t._s(e.path)+" :")])]},proxy:!0}],null,!0),model:{value:t.wndCounter.counters[n],callback:function(e){t.$set(t.wndCounter.counters,n,e)},expression:"wndCounter.counters[idx]"}})})),t.tableProducts.rows[t.wndCounter.idxrow].locations.length>1?o("div",[t._v("Total: "+t._s(t.counterToSave))]):t._e()],2),o("q-card-actions",{attrs:{align:"around"}},[o("q-btn",{attrs:{label:"Cancelar",flat:"",rounded:"",color:"light-blue-13","no-caps":""},on:{click:t.counterCancel}}),t.wndCounter.counters.length?[o("q-btn",{attrs:{flat:"","no-caps":"",rounded:"",color:"green-13",label:"Guardar",disable:t.wndCounter.saving,loading:t.wndCounter.saving},on:{click:t.save}})]:t._e()],2)],1):t._e()],1),this.index?[2==this.index.inventory.status.id&&t.imCreator&&1==t.progress.value?o("q-page-sticky",{attrs:{position:"bottom-right",offset:[10,10]}},[o("q-btn",{staticClass:"bg-darkl1 text-green-13",attrs:{rounded:"",icon:"done",label:"Terminar","no-caps":""},on:{click:t.terminate}})],1):t._e(),3==this.index.inventory.status.id?o("q-page-sticky",{attrs:{position:"bottom-right",offset:[10,10]}},[o("q-btn",{staticClass:"bg-darkl1 text-green-13",attrs:{rounded:"",icon:"fas fa-file-download",label:"Reporte","no-caps":""},on:{click:t.buildPDF}})],1):t._e()]:t._e()]:t._e()],2)},s=[],r=(o("e01a"),o("13d5"),o("e6cf"),o("ddb0"),o("8055")),i=o.n(r),a=o("e0df"),l=o("007d"),d=o("8baf"),c=(o("0da4"),{data(){return{index:null,tableProducts:{rows:[],visibleCols:["code","locations","counter","state"],columns:[{name:"id",align:"left",label:"ID",field:t=>t.id,sortable:!0},{name:"code",align:"left",label:"Codigo",field:t=>t.code,sortable:!0},{name:"locations",align:"center",label:"Ubicaciones",field:t=>t._locations,sortable:!0},{name:"counter",align:"center",label:"Conteo",field:t=>t.counter,sortable:!0},{name:"state",align:"center",label:"Estatus",field:t=>t.state,sortable:!0}]},productsRefresh:[],socket:null,imCreator:!1,wndCounter:{state:!1,idxrow:null,counters:[],saving:!1,stateIfCancel:null},sktcounter:null,countingrespo:null,joined:!1}},async beforeMount(){this.$store.commit("Layout/hideToolbarModule"),this.$q.loading.show({message:"Validando...",spinner:l["a"],spinnerColor:"green-13"}),this.index=await a["a"].find(this.$route.params.id),console.log(this.index),this.index.success?this.stay()?(console.log("Acceso Exitoso!!, formateando filas..."),this.index.inventory.products.forEach((t=>{t.state=t.ordered.details.settings?1:3,t._locations=t.locations.map((t=>t.path)).join(", "),t.counter=t.ordered.stocks_acc,this.tableProducts.rows.unshift(JSON.parse(JSON.stringify(t)))})),console.log("... LISTO!!!"),console.log(`Uniendo al ROOM ${this.socketroom}...`),this.sktcounter=await i()(this.$vsocket+"/counters"),this.sktcounter.emit("joinat",{room:this.socketroom,user:this.profile}),this.sktcounter.on("joined",(t=>{this.sktjoined(t)})),this.sktcounter.on("counting",(t=>{this.sktcounting(t)})),this.sktcounter.on("cancelcounting",(t=>{this.sktcancelcounting(t)})),this.sktcounter.on("countingconfirmed",(t=>{this.sktcountingconfirmed(t)}))):this.notifyExclution():this.notify404(),this.$q.loading.hide()},beforeDestroy(){this.$store.commit("Layout/showToolbarModule")},methods:{sktcountingconfirmed(t){console.log("%cSe ha confirmado un conteo!!!","font-size:2em;color:gold"),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.tableProducts.rows[e].state=1,this.tableProducts.rows[e].counter=t.settings.stock},sktjoined(t){t.me.id!=this.profile.me.id&&this.$q.notify({color:"dark",message:t.me.nick+" se ha unido al conteo",position:"bottom-left",textColor:"green-13",timeout:1200,avatar:"https://cdn.quasar.dev/img/boy-avatar.png"})},sktcounting(t){console.log("Contando elemento..."),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.countingrespo=t.by,this.tableProducts.rows[e].state=2},sktcancelcounting(t){console.log("Cancelando elemento de forma remota"),console.log(t);let e=this.tableProducts.rows.findIndex((e=>e.id==t.product.id));this.tableProducts.rows[e].state=3,this.countingrespo=null},terminate(t,e){this.$q.loading.show({message:"Finalizando Inventario, espera..."}),console.log(this.index.inventory.id);let o={_inventory:this.index.inventory.id,_status:3};console.log("Ejecutando NextStep..."),console.log(o),a["a"].nextStep(o).then((t=>{let e=t.data;console.log(e),this.productsRefresh=e.order.products,this.index.inventory.status=e.order.status})).catch((t=>{console.log(t)}))},save(){this.wndCounter.saving=!0,this.tableProducts.rows[this.wndCounter.idxrow].counter=this.counterToSave,this.tableProducts.rows[this.wndCounter.idxrow].state=1;let t=this.tableProducts.rows[this.wndCounter.idxrow],e={_product:t.id,_inventory:this.index.inventory.id,stock:this.counterToSave,settings:{locs:t.locations,values:this.wndCounter.counters,modified:!0}};a["a"].rowCount(e).then((o=>{let n=o.data;console.log(n),this.$q.notify({color:"positive",icon:"done",position:"center",timeout:1e3,message:"Guardado!"}),console.log("%cConfirmando conteo...!!!","font-size:2em;color:gold"),this.sktcounter.emit("countingconfirmed",{room:this.socketroom,product:t,by:this.profile,settings:e}),this.counterReset(),this.wndCounter.state=!1})).catch((t=>{console.log(t)}))},counterCancel(){console.log("Se ha Cancelado el Contador"),this.tableProducts.rows[this.wndCounter.idxrow].state=this.wndCounter.stateIfCancel,this.sktcounter.emit("cancelcounting",{room:this.socketroom,by:this.profile,product:this.tableProducts.rows[this.wndCounter.idxrow]}),this.counterReset(),this.wndCounter.state=!1},counter(t){console.log(t);let e=t.key,o=this.tableProducts.rows.findIndex((t=>t.id==e));this.wndCounter.stateIfCancel=this.tableProducts.rows[o].state,this.tableProducts.rows[o].state=2,this.wndCounter.idxrow=o,this.wndCounter.state=!0;let n=this.tableProducts.rows[o];this.sktcounter.emit("counting",{room:this.socketroom,product:n,by:this.profile})},counterReset(){this.wndCounter.idxrow=null,this.wndCounter.counters=[],this.wndCounter.saving=!1,this.countingrespo=null},stay(){if(this.index.inventory.created_by.id==this.profile.me.id||1==this.profile.me._rol)return this.imCreator=!0,!0;{let t=this.index.inventory.responsables.findIndex((t=>t.id==this.profile.me.id));return t>=0}},notifyExclution(){this.$q.notify({message:"Raios!!, No eres miembro de este conteo!!",icon:"fas fa-sad-cry",timeout:1e3,color:"negative",position:"top"}),this.$router.push("/almacen/contador")},notify404(){this.$q.notify({message:`Raios!!, el folio ${this.$route.params.id} no existe!!`,icon:"fas fa-sad-cry",timeout:1e3,color:"negative",position:"top"}),this.$router.push("/almacen/contador")},buildPDF(){console.log("%cConstruyendo Documento...","font-size:2em;color:orange;"),this.$q.loading.show({message:"Generando Reporte..."}),console.log(this.index);let t=this.log.filter((t=>1==t.id))[0],e=this.log.filter((t=>3==t.id))[0],o=this.$moment(t.created_at),n=this.$moment(e.created_at),s=n.diff(o,"m"),r=1,i="21"+this.index.inventory.id,a=i+".pdf",l=o.format("MM/DD/YYYY h:mm a"),c=n.format("MM/DD/YYYY h:mm a"),u=this.index.inventory.type,h=`${this.index.inventory.created_by.names} ${this.index.inventory.created_by.surname_pat} [${this.index.inventory.created_by.nick}]`,p=this.index.inventory.responsables;const g=new d["jsPDF"]({unit:"pt",format:"letter"});g.addFont("pdf/ParadroidMono-Light.ttf","Paradroid","normal"),g.setFont("Paradroid");let m={w:g.internal.pageSize.getWidth(),h:g.internal.pageSize.getHeight()},f=m.w-50,b=m.h-80,w=[...this.tableProducts.rows].map((t=>{let e=parseInt(t.ordered.stocks),o=parseInt(t.ordered.stocks_acc),n=()=>e>o?"-"+(e-o):e<o?"+"+(o-e):e==o?0:void 0,s=()=>e>o?(o/e*100).toFixed(0):o>e?(e/o*100).toFixed(0):e==o?100:void 0,r=()=>{let e=t.description.length>=35?t.description.substring(0,35)+"...":t.description;return e.toUpperCase()};return[t.code,r(),e,o,n(),"","",s()]}));var x=[{name:"code",prompt:"Articulo",width:70},{name:"descript",prompt:"Descripcion",width:185},{name:"initstock",prompt:"SAI",width:40},{name:"counter",prompt:"UC",width:40},{name:"fs",prompt:"F/S",width:40},{name:"endstock",prompt:"SAT",width:40},{name:"locations",prompt:"Ubicaciones",width:100},{name:"presition",prompt:"Pres.",width:40}];let v=t=>{g.setFontSize(7),g.text(""+r,f/2+10,b+50,{align:"center",baseline:"middle"}),g.text(`Inventario ${i}, ${this.profile.workpoint.alias}`,575,b+50,{align:"right",baseline:"middle"})},C=(t,e)=>{g.setFillColor("#000000"),g.line(t,e,575,e,"F"),e+=20;let o=1;g.setFontSize(11);for(const n of x)g.setTextColor("#2d3436"),g.text(""+n.prompt,t,e),o++,o>1&&(t+=n.width);t=25,e+=13,g.setFillColor("#000000"),g.line(t,e,575,e,"F")};g.addImage("pdf/rsi.png","PNG",355,5,250,60),g.addImage("pdf/logo_org.png","PNG",35,22,170,50),g.setFontSize(12),g.setTextColor("#ffffff"),g.text("Inventario "+i,570,29,{align:"right",baseline:"middle"}),g.setFontSize(10),g.text(""+this.profile.workpoint.name,570,45,{align:"right",baseline:"middle"}),g.setTextColor("#000000");let y=25,k=112;g.text("Duracion: ",y,k),g.text("Inicio: ",y,k+=13),g.text("Termino: ",y,k+=13),g.text("Tipo: ",y,k+=13),y=80,k=112,g.text(s+" minutos",y,k),g.text(""+l,y,k+=13),g.text(""+c,y,k+=13),g.text(""+u.name,y,k+=13),y=290,k=112,g.text("Administrador: ",y,k),g.text("Responsables: ",y,k+=13),g.text("Productos: ",y,k+=13),y=380,k=112,g.text(""+h,y,k),g.text(""+p.length,y,k+=13),g.text(""+this.index.inventory.products.length,y,k+=13),C(25,170),v(1),g.setFontSize(8),y=25,k=205;let _=0;for(const d of w){_%2==0?g.setFillColor("#ffffff"):g.setFillColor("#ced6e0"),g.rect(y,k,550,20,"F");for(let t=0;t<d.length;t++)g.text(""+d[t],y,k+7,{baseline:"hanging"}),y+=x[t].width;k>b?(k=70,g.addPage(),r++,C(25,30),v(1,1),g.setFontSize(8),r++):k+=20,_++,y=25}g.setFontSize(12),k+=40,y=25,k+=10,g.setFontSize(10);for(const d of p)g.text(`${d.names} ${d.surname_pat}`,25,k+=30,{baseline:"hanging"});g.save(a),this.$q.loading.hide()}},computed:{profile(){return this.$store.getters["Account/profile"]},rowsDone(){return this.tableProducts.rows.filter((t=>null!=t.counter))},progress(){let t=0,e=this.tableProducts.rows.length,o=this.rowsDone.length,n=this.index?parseFloat((100*o/e).toFixed(2)):0,s=`${o} de ${e} : ${n}%`;return t=parseFloat(n/100).toFixed(2),{label:s,value:parseFloat(t)}},counterToSave(){return null!=this.wndCounter.idxrow?this.wndCounter.counters.reduce(((t,e)=>t+parseInt(e)),0):null},ismobile(){return this.$q.platform.is.mobile},socketroom(){return"COUNTER"+this.$route.params.id},log(){return this.index?this.index.inventory.log:[]}}}),u=c,h=o("2877"),p=o("9989"),g=o("e359"),m=o("65c6"),f=o("9c40"),b=o("eb85"),w=o("6b1d"),x=o("58a81"),v=o("f09f"),C=o("a370"),y=o("eaac"),k=o("bd08"),_=o("db86"),q=o("0016"),P=o("8380"),$=o("24e8"),S=o("27f9"),F=o("4b7e"),I=o("de5e"),T=o("eebe"),z=o.n(T),Q=Object(h["a"])(u,n,s,!1,null,null,null);e["default"]=Q.exports;z()(Q,"components",{QPage:p["a"],QHeader:g["a"],QToolbar:m["a"],QBtn:f["a"],QSeparator:b["a"],QLinearProgress:w["a"],QBadge:x["a"],QCard:v["a"],QCardSection:C["a"],QTable:y["a"],QTr:k["a"],QTd:_["a"],QIcon:q["a"],QSpinnerDots:P["a"],QDialog:$["a"],QInput:S["a"],QCardActions:F["a"],QPageSticky:I["a"]})},e0df:function(t,e,o){"use strict";var n=o("31b8");e["a"]={index(){return n["b"].get("inventory").then((t=>t.data)).catch((t=>{console.log(t)}))},find(t){return n["b"].get("inventory/"+t).then((t=>t.data)).catch((t=>{console.log(t)}))},create(t){return n["b"].post("inventory",t)},toggleReponsable(t){return n["b"].post("inventory/responsable",t)},addProducts(t){return n["b"].post("inventory/add",t)},nextStep(t){return n["b"].post("inventory/next",t)},rowCount(t){return n["b"].post("inventory/value",t)}}}}]);